import pandas as pd
from pathlib import Path

# Define paths
input_file = Path("scripts/gpt4o/version2/execution3/analysis_data/step3_repeats_marked.csv")
output_dir = Path("scripts/gpt4o/version2/execution3/analysis_data")
output_dir.mkdir(parents=True, exist_ok=True)
output_file = output_dir / "step4_employee_counts.csv"

print("Starting Step 4: Counting total employees per organization per year...\n")

if not input_file.exists():
    print(f"‚ùå Input file not found: {input_file}")
    exit(1)

try:
    df = pd.read_csv(input_file)

    # Normalize organization names to avoid mismatch due to casing or whitespace
    df['org'] = df['org'].str.strip().str.lower()

    # Group by organization and year, then count entries
    employee_counts = df.groupby(['org', 'year']).size().reset_index(name='total_appointments')

    # Save result
    employee_counts.to_csv(output_file, index=False)
    print(f"‚úÖ Employee counts by org and year saved to: {output_file}")
    print(f"üìä Records: {employee_counts.shape[0]} (organizations x years)")

except Exception as e:
    print(f"‚ùå Failed to compute employee counts: {e}")
